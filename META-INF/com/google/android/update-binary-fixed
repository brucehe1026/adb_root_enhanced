#!/sbin/sh

#################
# Initialization
#################

umask 022

# echo before loading util_functions
ui_print() { echo "$1"; }

require_new_magisk() {
  ui_print "*******************************"
  ui_print " Please install Magisk v20.4+! "
  ui_print "*******************************"
  exit 1
}

#########################
# Load util_functions.sh
#########################

OUTFD=$2
ZIPFILE=$3

mount /data 2>/dev/null

[ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
. /data/adb/magisk/util_functions.sh
[ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk

#########################
# Enhanced Installation
#########################

ui_print "*******************************"
ui_print " ADB Root Enhanced v2.0 "
ui_print " Android 9/10/11/12+ Support "
ui_print "*******************************"

# Detect Android version
API_LEVEL=$(getprop ro.build.version.sdk)
ANDROID_VERSION=$(getprop ro.build.version.release)

case $API_LEVEL in
    28|29) 
        ui_print "Detected Android 9/10 (API $API_LEVEL)"
        ui_print "Using SELinux policy enhancement only"
        ANDROID_10_COMPAT=true
        ;;
    30|31|32|33)
        ui_print "Detected Android 11/12/13+ (API $API_LEVEL)"
        ui_print "Using enhanced bypass method for modern Android"
        ANDROID_10_COMPAT=false
        ;;
    *)
        ui_print "Detected Android $ANDROID_VERSION (API $API_LEVEL)"
        ui_print "Using enhanced bypass method (experimental)"
        ANDROID_10_COMPAT=false
        ;;
esac

# Check architecture
ARCH=$(getprop ro.product.cpu.abi)
if [[ "$ARCH" != "arm64-v8a" ]]; then
    ui_print "Warning: This module is designed for arm64-v8a devices"
    ui_print "Current architecture: $ARCH"
    ui_print "Proceeding anyway..."
fi

# Install the module
install_module

# Android 10 specific setup
if [ "$ANDROID_10_COMPAT" = true ]; then
    ui_print "Configuring Android 10 compatibility..."
    
    # For Android 10, we only enhance SELinux policies
    # Don't replace the adbd binary to maintain compatibility
    rm -f "$MODPATH/system/bin/adbd"
    ui_print "Removed adbd binary replacement for Android 10 compatibility"
    
    # Keep only SELinux policy enhancements
    ui_print "SELinux policy enhancement applied"
fi

# Additional setup for modern Android versions
if [ $API_LEVEL -ge 30 ]; then
    ui_print "Configuring enhanced SELinux policies for Android 11+..."
    
    # Ensure proper file contexts
    chcon u:object_r:system_file:s0 $MODPATH/system/bin/adbd 2>/dev/null || true
    
    # Additional SELinux setup for modern Android
    if [ -f /sys/fs/selinux/enforce ]; then
        ui_print "SELinux detected, applying enhanced policies..."
    fi
fi

ui_print "*******************************"
ui_print "Installation complete!"
ui_print "Please reboot your device"
ui_print "*******************************"

exit 0
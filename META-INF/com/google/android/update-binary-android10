#!/sbin/sh

# Magisk Module Installation Script for Android 10 Compatibility
# This is a standard Magisk module installer

#################
# Initialization
#################

umask 022

# echo before loading util_functions
ui_print() { echo "$1"; }

require_new_magisk() {
  ui_print "*******************************"
  ui_print " Please install Magisk v20.4+! "
  ui_print "*******************************"
  exit 1
}

#########################
# Load util_functions.sh
#########################

OUTFD=$2
ZIPFILE=$3

mount /data 2>/dev/null

[ -f /data/adb/magisk/util_functions.sh ] || require_new_magisk
. /data/adb/magisk/util_functions.sh
[ $MAGISK_VER_CODE -lt 20400 ] && require_new_magisk

#########################
# Installation
#########################

ui_print "*******************************"
ui_print " ADB Root - Android 10 Compatible "
ui_print " SELinux Policy Enhancement Only "
ui_print "*******************************"

# Detect Android version
API_LEVEL=$(getprop ro.build.version.sdk)
ui_print "Detected Android API level: $API_LEVEL"

if [ "$API_LEVEL" = "29" ]; then
    ui_print "Android 10 detected - using compatibility mode"
    ui_print "This version only enhances SELinux policies"
    ui_print "Original adbd binary will be preserved"
else
    ui_print "This module is specifically for Android 10"
    ui_print "Your device may not be fully compatible"
fi

# Install the module (standard Magisk installation)
install_module

# Android 10 specific: Remove any binary replacement
if [ "$API_LEVEL" = "29" ]; then
    ui_print "Removing binary replacement for Android 10 compatibility..."
    rm -f "$MODPATH/system/bin/adbd" 2>/dev/null || true
    ui_print "✓ Original adbd binary preserved"
fi

# Apply SELinux policy
if [ -f "$MODPATH/sepolicy.rule" ]; then
    ui_print "✓ SELinux policy will be applied on boot"
else
    ui_print "⚠ No SELinux policy found"
fi

ui_print ""
ui_print "*******************************"
ui_print "Installation complete!"
ui_print ""
ui_print "After reboot:"
ui_print "1. Test ADB connection: adb devices"
ui_print "2. Test root access: adb root"
ui_print "3. Check status: adb shell id"
ui_print ""
ui_print "If ADB doesn't work, uninstall this module"
ui_print "*******************************"

exit 0